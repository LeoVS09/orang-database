#!/usr/bin/env make

.PHONY: all build start clean production start-dev dump-schema dump-graphql setup dev docker-build docker-console build-console

export NODE_ENV=development

# ---------------------------------------------------------------------------------------------------------------------
# CONFIG
# ---------------------------------------------------------------------------------------------------------------------
DOCKER_IMAGE_VERSION=0.1.0
DOCKER_IMAGE_TAG=orange-database/$(DOCKER_IMAGE_VERSION)

# ---------------------------------------------------------------------------------------------------------------------
# SETUP
# ---------------------------------------------------------------------------------------------------------------------

setup:
	./bin/setup.sh

# ---------------------------------------------------------------------------------------------------------------------
# UTILS
# ---------------------------------------------------------------------------------------------------------------------

clean:
	rm -rf dist

env-to-list:
	node bin/env-to-list.js

# ---------------------------------------------------------------------------------------------------------------------
# DEVELOPMENT
# ---------------------------------------------------------------------------------------------------------------------

build: clean
	yarn build

start-dev:
	./bin/start-dev.sh

dev: build
	make watch & make start-dev

watch:
	yarn watch

# ---------------------------------------------------------------------------------------------------------------------
# PRODUCTION
# ---------------------------------------------------------------------------------------------------------------------

production: clean
	./node_modules/.bin/babel ./src -d ./dist --extensions ".ts"

start: production
	./bin/start.sh

# ---------------------------------------------------------------------------------------------------------------------
# DUMP
# ---------------------------------------------------------------------------------------------------------------------

dump-schema:
	./bin/dump-schema.sh

dump-graphql:
	./bin/dump-graphql.sh

# ---------------------------------------------------------------------------------------------------------------------
# DOCKER
# ---------------------------------------------------------------------------------------------------------------------

docker-build:
	@docker build -t $(DOCKER_IMAGE_TAG) .

docker-console: env-to-list
	docker-compose run --publish=8765:8765 orange-database  /bin/bash

build-console: docker-build docker-console

db-up:
	docker-compose up db

docker-up:
	docker-compose up
